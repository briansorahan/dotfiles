#!/bin/bash
#
# Emacs setup script.
# Brian Sorahan
#
# Warn the user of the dangers of running this script!
#
echo    "This script will completely overwrite your .emacs file!"
echo -n "Would you like to continue? "
read CONTINUE
if [ ${CONTINUE:0:1} = "n" ] || [ ${CONTINUE:0:1} = "N" ]; then
    exit
fi
#
# Setup my emacs environment without me having to lift a finger!
#
PWD=`pwd`
TEMP=/tmp
#
# js2-mode repo
# This is a fork of mooz's repo with default indentation set to 2 spaces.
#
JS2_REPO="git://github.com/briansorahan/js2-mode.git"
#
# workgroups repo
#
WORKGROUPS_REPO="git://github.com/tlh/workgroups.el.git"
#
# emacs zencoding minor mode
#
ZENCODING_REPO="git://github.com/rooney/zencoding.git"
#
# Default workgroup is relative to the emacs-setup repo
#
DEFAULT_WORKGROUP="${PWD}/workgroups/default.el"
#
# Directory where we will put .el files.
# This can be overridden with the -d option, but *must* be on your
# emacs load-path. 
#
EMACS_LOAD_DIR=~/.emacs.d/site-lisp
#
# Load key bindings from a file
#
KEY_BINDINGS=`cat keybindings.el`
#
#
# Load other configuration
#
CONF_EL=`cat conf.el`
#
################################################################################
#
# Get command-line options
#
################################################################################
#
while getopts "d:u:" option
do
    case $option in
        d ) EMACS_LOAD_DIR=$OPTARG ;; 
    esac
done

if [ ! -d ${EMACS_LOAD_DIR} ]; then
    mkdir -p ${EMACS_LOAD_DIR}
fi
#
################################################################################
#
# Create the .emacs file
#
################################################################################
#
cat >~/.emacs <<DOT_EMACS
;;
;; This file was automatically generated by emacs-setup/run
;;
${KEY_BINDINGS}

${CONF_EL}
DOT_EMACS
#
################################################################################
#
# Setup js2-mode
#
################################################################################
#
cd ${TEMP}
if [ -d js2-mode ]; then
    rm -rf js2-mode
fi
git clone ${JS2_REPO}
cd js2-mode
emacs --batch --eval '(byte-compile-file "js2-mode.el")'
rm -rf ${EMACS_LOAD_DIR}/js2-mode*
cp js2-mode.elc ${EMACS_LOAD_DIR}
cd .. && rm -rf js2-mode
#
################################################################################
#
# Setup workgroups
#
################################################################################
#
cd ${TEMP}
if [ -d workgroups.el ]; then
    rm -rf workgroups.el
fi
git clone ${WORKGROUPS_REPO}
cd workgroups.el
emacs --batch --eval '(byte-compile-file "workgroups.el")'
rm -rf ${EMACS_LOAD_DIR}/workgroups*
cp workgroups.elc ${EMACS_LOAD_DIR}
cd .. && rm -rf workgroups.el
#
################################################################################
#
# Setup zencoding
#
################################################################################
#
cd ${TEMP}
if [ -d zencoding ]; then
    rm -rf zencoding
fi
git clone ${ZENCODING_REPO}
cd zencoding
emacs --batch --eval '(byte-compile-file "zencoding-mode.el")'
rm -rf ${EMACS_LOAD_DIR}/zencoding*
cp zencoding-mode.elc ${EMACS_LOAD_DIR}
cd .. && rm -rf zencoding
#
################################################################################
#
# Setup dired-details (and dired-details+)
#
################################################################################
#
cd ${EMACS_LOAD_DIR}
rm -rf dired-details*
wget http://www.emacswiki.org/emacs/download/dired-details.el
wget http://www.emacswiki.org/emacs-en/download/dired-details%2b.el
emacs --batch --eval '(byte-compile-file "dired-details.el")'
emacs --batch --eval '(byte-compile-file "dired-details+.el")'
#
################################################################################
#
# Setup buffer-move
#
################################################################################
#
cd ${EMACS_LOAD_DIR}
rm -rf buffer-move*
wget http://www.emacswiki.org/emacs/download/buffer-move.el
emacs --batch --eval '(byte-compile-file "buffer-move.el")'
#
################################################################################
#
# Setup autofit-frame
# I wanted to use this with dired-details to 
#
################################################################################
#
cd ${EMACS_LOAD_DIR}
rm -rf fit-frame*
wget http://www.emacswiki.org/emacs-en/download/fit-frame.el
emacs --batch --eval '(byte-compile-file "fit-frame.el")'
rm -rf autofit-frame*
wget http://www.emacswiki.org/emacs-en/download/autofit-frame.el
emacs --batch --eval '(byte-compile-file "autofit-frame.el")'
